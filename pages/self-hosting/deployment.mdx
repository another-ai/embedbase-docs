import Image from 'next/image'

# Deploying Embedbase

For any help or assistance with deployment, [book a demo](https://cal.com/potato/20min) and we will help you deploy your own instance.

## Using Supabase

There are multiple ways to use Supabase, either [running it locally](https://supabase.com/docs/guides/cli/local-development) or using their hosted instance.

First, create a supabase project on https://supabase.com.

Then you can setup Supabase database either using Supabase UI or via [Supabase CLI](https://supabase.com/docs/guides/cli)

### Using CLI

```bash
git clone https://github.com/different-ai/embedbase
supabase init
```

Use the reset command here to reset the database to the current [migrations](https://github.com/different-ai/embedbase/tree/main/supabase/migrations).

```bash
supabase db reset
```

Now you can [Setup your configuration file](#setup-your-configuration-file)

### Using Supabase UI

1. Go to SQL Editor 

<Image src="/supabase-click-on-sqleditor.png" width={500} height={300} />

2. Enable pgvector extension by running the following query

```sql
create extension vector
with
  schema extensions;
```

3. Run the following query to create the table

```sql
create table documents (
    id text primary key,
    data text,
    embedding vector (1536),
    hash text,
    dataset_id text,
    user_id text,
    metadata json
);
```

4. Enable row-level security (prevent client from read & write access to the db)

```sql
alter table documents
  enable row level security;
```

5. Create the search database function

```sql
create or replace function match_documents (
  query_embedding vector(1536),
  similarity_threshold float,
  match_count int,
  query_dataset_id text,
  query_user_id text default null
)
returns table (
  id text,
  data text,
  score float,
  hash text,
  embedding vector(1536),
  metadata json
)
language plpgsql
as $$
begin
  return query
  select
    documents.id,
    documents.data,
    (1 - (documents.embedding <=> query_embedding)) as similarity,
    documents.hash,
    documents.embedding,
    documents.metadata
  from documents
  where 1 - (documents.embedding <=> query_embedding) > similarity_threshold
    and query_dataset_id = documents.dataset_id
    and (query_user_id is null or query_user_id = documents.user_id)
  order by documents.embedding <=> query_embedding
  limit match_count;
end;
$$;
```

6. Create the index

```sql
create index on documents
using ivfflat (embedding vector_cosine_ops)
with (lists = 100);
```

7. Create a view for the /datasets endpoint

```sql
CREATE OR REPLACE VIEW distinct_datasets AS
SELECT dataset_id, user_id, COUNT(*) AS documents_count
FROM documents
GROUP BY dataset_id, user_id;
```

### Setup your configuration file

Add the following to your config.yaml file

```yaml
vector_database: supabase
supabase_url: '<get me here https://supabase.com>'
supabase_key: '<get me here https://supabase.com>'
openai_api_key: '<get me here https://platform.openai.com/account/api-keys>'
openai_organization: '<get me here https://platform.openai.com/account/org-settings>'
```

ðŸŽ‰ Now you should be able to run Embedbase with Supabase

```bash
docker-compose up
```

## Cloud Run deployment

Embedbase makes it easy for you to deploy your own instance. This assures you're in control of your data end to end.

### Setup

```bash
# login to gcloud
gcloud auth login

PROJECT_ID=$(gcloud config get-value project)

# Enable container registry
gcloud services enable containerregistry.googleapis.com

# Enable Cloud Run
gcloud services enable run.googleapis.com

# Enable Secret Manager
gcloud services enable secretmanager.googleapis.com

# create a secret for the config
gcloud secrets create EMBEDBASE --replication-policy=automatic

# add a secret version based on your yaml config
gcloud secrets versions add EMBEDBASE --data-file=config.yaml

IMAGE_URL="gcr.io/${PROJECT_ID}/embedbase:0.0.1"

docker buildx build . --platform linux/amd64 -t ${IMAGE_URL} -f ./docker/Dockerfile

docker push ${IMAGE_URL}

gcloud run deploy embedbase \
  --image ${IMAGE_URL} \
  --region us-central1 \
  --allow-unauthenticated \
  --set-secrets /secrets/config.yaml=EMBEDBASE:1

# getting cloud run url
gcloud run services list --platform managed --region us-central1 --format="value(status.url)" --filter="metadata.name=embedbase"
```
